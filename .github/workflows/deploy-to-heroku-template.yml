name: CI/CD â€” Build & Deploy to Heroku (Container Registry) (Template)

# Template workflow: copy this file and update the matrix/services to match your repo layout.
# Required secrets in repository: HEROKU_API_KEY, HEROKU_APP_<SERVICE_NAME> for each service

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - service: backend
            context: backend
            dockerfile: Dockerfile
            process: web
          # Add additional services below (example):
          # - service: websocket
          #   context: webSocketEngine
          #   dockerfile: DockerFile
          #   process: web
    steps:
      - uses: actions/checkout@v4

      - name: Set HEROKU_APP env from secrets
        run: |
          if [ "${{ matrix.service }}" = "backend" ]; then echo "HEROKU_APP=${{ secrets.HEROKU_APP_BACKEND }}" >> $GITHUB_ENV; fi
          # Add mapping for other services if needed

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Heroku Container Registry
        run: echo "${{ secrets.HEROKU_API_KEY }}" | docker login --username=_ --password-stdin registry.heroku.com

      - name: Build and push Docker image to Heroku
        run: |
          IMAGE=registry.heroku.com/${HEROKU_APP}/${{ matrix.process }}
          docker build -t $IMAGE -f ${{ matrix.context }}/${{ matrix.dockerfile }} ${{ matrix.context }}
          docker push $IMAGE

      - name: Install Heroku CLI
        run: curl https://cli-assets.heroku.com/install.sh | sh

      - name: Release image on Heroku
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
        run: |
          heroku container:release ${{ matrix.process }} --app $HEROKU_APP

      - name: Post-deploy smoke check
        run: |
          if [ "${{ matrix.process }}" = "web" ]; then 
            URL="https://${HEROKU_APP}.herokuapp.com/health"
            echo "Checking $URL"
            curl -fsS $URL || (echo "Smoke test failed" && exit 1)
          else
            echo "Worker process deployed for ${HEROKU_APP}, no web smoke check"
            echo "Tip: Use Heroku Scheduler to run periodic commands, or run a one-off test using 'heroku run --app ${HEROKU_APP} <command>'"
            # Example (uncomment to run as part of the workflow - requires HEROKU_API_KEY and a valid command):
            # echo "Running worker test command..."
            # heroku run --app ${HEROKU_APP} "./rating-cron-binary --once"
          fi

      # Optional: a commented example workflow job for running a manual worker test using Heroku CLI.
      # You can copy this into your workflow file to add a manual trigger (workflow_dispatch) to run one-off commands.
      #
      # Example (uncomment to enable):
      #
      # worker-test:
      #  name: Manual worker test (Heroku run)
      #  runs-on: ubuntu-latest
      #  permissions: write-all
      #  steps:
      #    - uses: actions/checkout@v4
      #    - name: Install Heroku CLI
      #      run: curl https://cli-assets.heroku.com/install.sh | sh
      #    - name: Run worker test command
      #      env:
      #        HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
      #      run: |
      #        # replace <COMMAND> with the one-off command you want to run, for example './rating-cron-binary --once' or 'python backend/scripts/fill_db.py'
      #        heroku run --app ${{ secrets.HEROKU_APP_BACKEND }} "<COMMAND>"
      #
      # Note: enabling this requires that the GH Actions runner can authenticate with Heroku via HEROKU_API_KEY and that the secret HEROKU_APP_* is present.
